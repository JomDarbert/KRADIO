var CronJob,cheerio,fs,get_data,out_file,pages,request,songs,update_data;request=require("request"),cheerio=require("cheerio"),fs=require("fs"),CronJob=require("cron").CronJob,songs=[],out_file="songs.json",pages=["http://www.eatyourkimchi.com/kpopcharts/","http://www.eatyourkimchi.com/kpopcharts/page/2/","http://www.eatyourkimchi.com/kpopcharts/page/3/","http://www.eatyourkimchi.com/kpopcharts/page/4/","http://www.eatyourkimchi.com/kpopcharts/page/5/","http://www.eatyourkimchi.com/kpopcharts/page/6/","http://www.eatyourkimchi.com/kpopcharts/page/7/","http://www.eatyourkimchi.com/kpopcharts/page/8/","http://www.eatyourkimchi.com/kpopcharts/page/9/","http://www.eatyourkimchi.com/kpopcharts/page/10/","http://mwave.interest.me/kpop/chart.m"],get_data=function(t,e){var r,a,o,i,p;for(p=[],o=0,i=t.length;i>o;o++)a=t[o],r=0,p.push(request(a,function(t,e,r){var a,o;t||200!==e.statusCode||(a=cheerio.load(r),o=[],a("div.bkp-listing").each(function(){var t,e,r,i,p,n;e=a(this).find("h2.bkp-toggle-vid").text().replace("(","").replace(")","").replace("'","").split(" â€“ "),t=e[0],n=e[1],i=t+" "+n,p=a(this).find("span.bkp-vid-rank").text(),r={artist:t,title:n,query:i.toLowerCase(),rank:p},o.push(r)}),a("div.list_song tr").each(function(){var t,e,r,i,p;t=a(this).find(".tit_artist a:first-child").text().replace("(","").replace(")","").replace("'",""),p=a(this).find(".tit_song a").text().replace("(","").replace(")","").replace("'",""),i=a(this).find(".nb em").text(),r=t+" "+p,e={artist:t,title:p,query:r.toLowerCase(),rank:i},o.push(e)}),songs.push(o))}).on("end",function(){var t;return r++,r===pages.length?(t=[],t=t.concat.apply(t,songs),e(t)):void 0}));return p},(update_data=function(){return get_data(pages,function(t){return fs.readFile(out_file,"utf8","w",function(e,r){var a,o,i,p,n,s,c,h;for(p=e?[]:JSON.parse(r),o={date:new Date,data:t},p.unshift(o),p.length>100&&p.splice(p.length,1),a=function(t,e){var r,a;return r=Number(t.rank),a=Number(e.rank),a>r?-1:r>a?1:0},p[0].data.sort(a),h=p[0].data,i=s=0,c=h.length;c>s;i=++s)n=h[i],n.rank=i+1;return fs.writeFile(out_file,JSON.stringify(p),function(t){if(t)throw t;console.log("JSON saved to "+out_file)})})})})();

var CronJob,cheerio,fs,get_data,out_file,pages,request,songs,update_data;request=require("request"),cheerio=require("cheerio"),fs=require("fs"),CronJob=require("cron").CronJob,songs=[],out_file="songs.json",pages=["http://www.eatyourkimchi.com/kpopcharts/","http://www.eatyourkimchi.com/kpopcharts/page/2/","http://www.eatyourkimchi.com/kpopcharts/page/3/","http://www.eatyourkimchi.com/kpopcharts/page/4/","http://www.eatyourkimchi.com/kpopcharts/page/5/","http://www.eatyourkimchi.com/kpopcharts/page/6/","http://www.eatyourkimchi.com/kpopcharts/page/7/","http://www.eatyourkimchi.com/kpopcharts/page/8/","http://www.eatyourkimchi.com/kpopcharts/page/9/","http://www.eatyourkimchi.com/kpopcharts/page/10/","http://mwave.interest.me/kpop/chart.m"],get_data=function(t,e){var a,r,o,i,n;for(n=[],o=0,i=t.length;i>o;o++)r=t[o],a=0,n.push(request(r,function(t,e,a){var r,o;t||200!==e.statusCode||(r=cheerio.load(a),o=[],r("div.bkp-listing").each(function(){var t,e,a,i,n,p;e=r(this).find("h2.bkp-toggle-vid").text().replace("(","").replace(")","").replace("'","").split(" â€“ "),t=e[0],p=e[1],i=t+" "+p,n=r(this).find("span.bkp-vid-rank").text(),a={artist:t,title:p,query:i.toLowerCase(),rank:n},o.push(a)}),r("div.list_song tr").each(function(){var t,e,a,i,n;t=r(this).find(".tit_artist a:first-child").text().replace("(","").replace(")","").replace("'",""),n=r(this).find(".tit_song a").text().replace("(","").replace(")","").replace("'",""),i=r(this).find(".nb em").text(),a=t+" "+n,e={artist:t,title:n,query:a.toLowerCase(),rank:i},o.push(e)}),songs.push(o))}).on("end",function(){var t;return a++,a===pages.length?(t=[],t=t.concat.apply(t,songs),e(t)):void 0}));return n},update_data=function(){return get_data(pages,function(t){return fs.readFile(out_file,"utf8","w",function(e,a){var r,o,i,n,p,s,c,u,h,g,l,w,f,d,k,m,y,_;for(n=e?[]:JSON.parse(a),o={date:new Date,data:t},n.unshift(o),n.length>100&&n.splice(n.length,1),r=function(t,e){var a,r;return a=Number(t.rank),r=Number(e.rank),r>a?-1:a>r?1:0},n[0].data.sort(r),m=n[0].data,i=u=0,w=m.length;w>u;i=++u){for(c=m[i],c.rank=i+1,c.num_days=0,c.change=0,h=0,f=n.length;f>h;h++)for(o=n[h],y=o.data,g=0,d=y.length;d>g;g++)s=y[g],c.query===s.query&&c.num_days++;for(_=n[1].data,l=0,k=_.length;k>l;l++)p=_[l],c.query===s.query&&(c.change=p.rank-c.rank)}return fs.writeFile(out_file,JSON.stringify(n),function(t){if(t)throw t;console.log("JSON saved to "+out_file)})})})},new CronJob("0 0 * * *",function(){return update_data()},null,!0);

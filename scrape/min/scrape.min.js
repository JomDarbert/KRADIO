var CronJob,cheerio,fs,get_data,levenstein,out_file,pages,request,songs,sortQuery,sortRank,update_data;request=require("request"),cheerio=require("cheerio"),fs=require("fs"),CronJob=require("cron").CronJob,songs=[],out_file="songs.json",pages=["http://www.eatyourkimchi.com/kpopcharts/","http://www.eatyourkimchi.com/kpopcharts/page/2/","http://www.eatyourkimchi.com/kpopcharts/page/3/","http://www.eatyourkimchi.com/kpopcharts/page/4/","http://www.eatyourkimchi.com/kpopcharts/page/5/","http://www.eatyourkimchi.com/kpopcharts/page/6/","http://www.eatyourkimchi.com/kpopcharts/page/7/","http://www.eatyourkimchi.com/kpopcharts/page/8/","http://www.eatyourkimchi.com/kpopcharts/page/9/","http://www.eatyourkimchi.com/kpopcharts/page/10/","http://mwave.interest.me/kpop/chart.m"],levenstein=function(){var t;return t=[],function(e,r){var a,o,n,i,u,s,p,h,c;if(e===r)return 0;if(h=e.length,c=r.length,h&&c){for(u=0,s=0,a=void 0,o=void 0,n=void 0,i=void 0,p=t;h>u;)p[u]=++u;for(;c>s;)for(i=r.charCodeAt(s),a=s,++s,o=s,u=0;h>u;)n=a+(e.charCodeAt(u)!==i?1:0),a=p[u],o=a>o?n>o?o+1:n:n>a?a+1:n,p[u]=o,++u;return o}return h+c}}(),sortQuery=function(t,e){var r,a;return r=t.query,a=e.query,a>r?-1:r>a?1:0},sortRank=function(t,e){var r,a;return r=Number(t.rank),a=Number(e.rank),a>r?-1:r>a?1:0},get_data=function(t,e){var r,a,o,n,i;for(i=[],o=0,n=t.length;n>o;o++)a=t[o],r=0,i.push(request(a,function(t,e,r){var a,o;t||200!==e.statusCode||(a=cheerio.load(r),o=[],a("div.bkp-listing").each(function(){var t,e,r,n,i,u;e=a(this).find("h2.bkp-toggle-vid").text().replace("(","").replace(")","").replace("'","").split(" â€“ "),t=e[0],u=e[1],n=t+" "+u,i=a(this).find("span.bkp-vid-rank").text(),r={artist:t,title:u,query:n.toLowerCase(),rank:i},o.push(r)}),a("div.list_song tr").each(function(){var t,e,r,n,i;t=a(this).find(".tit_artist a:first-child").text().replace("(","").replace(")","").replace("'",""),i=a(this).find(".tit_song a").text().replace("(","").replace(")","").replace("'",""),n=a(this).find(".nb em").text(),r=t+" "+i,e={artist:t,title:i,query:r.toLowerCase(),rank:n},o.push(e)}),songs.push(o))}).on("end",function(){var t,a,o;if(r++,r===pages.length){for(o=[],o=o.concat.apply(o,songs),t=0,a=o.length;a>t;)o[t]&&o.push(o[t]),t++;return o.splice(0,a),e(o)}}));return i},update_data=function(){return get_data(pages,function(t){var e,r,a,o,n,i,u,s,p;for(t.sort(sortQuery),e=[],n="",r=0;r<t.length;)o=levenstein(t[r].query,n.query||""),o>6&&e.push(t[r]),n=t[r],r++;for(u=e,u.sort(sortRank),a=s=0,p=u.length;p>s;a=++s)i=u[a],i.rank=a+1,i.change=0,i.num_days=0;return fs.readFile(out_file,"utf8","w",function(t,e){var r,a,o,n,s,p,h,c,f,l,g,d,w,k,m,y;if(n=t?[]:JSON.parse(e),a={date:new Date,data:u},n.unshift(a),n.length>100&&n.pop,n.length>1)for(k=n[0].data,p=0,f=k.length;f>p;p++){if(i=k[p],r=0,n.length>=7)for(m=n[6].data,h=0,l=m.length;l>h;h++)s=m[h],s.query===i.query&&(i.change=s.rank-i.rank);for(c=0,g=n.length;g>c;c++)for(a=n[c],y=a.data,w=0,d=y.length;d>w;w++)o=y[w],o.query===i.query&&r++;i.num_days=r}return fs.writeFile(out_file,JSON.stringify(n),function(t){if(t)throw t;console.log("JSON saved to "+out_file)})})})},update_data(),new CronJob("0 0 * * *",function(){return update_data()},null,!0);

var CronJob,cheerio,fs,get_data,http,levenstein,out_file,pages,request,songs,sortQuery,sortRank,update_data;http=require("http"),request=require("request"),cheerio=require("cheerio"),fs=require("fs"),CronJob=require("cron").CronJob,songs=[],out_file="songs.json",pages=["http://www.eatyourkimchi.com/kpopcharts/","http://www.eatyourkimchi.com/kpopcharts/page/2/","http://www.eatyourkimchi.com/kpopcharts/page/3/","http://www.eatyourkimchi.com/kpopcharts/page/4/","http://www.eatyourkimchi.com/kpopcharts/page/5/","http://www.eatyourkimchi.com/kpopcharts/page/6/","http://www.eatyourkimchi.com/kpopcharts/page/7/","http://www.eatyourkimchi.com/kpopcharts/page/8/","http://www.eatyourkimchi.com/kpopcharts/page/9/","http://www.eatyourkimchi.com/kpopcharts/page/10/","http://mwave.interest.me/kpop/chart.m"],levenstein=function(){var t;return t=[],function(e,r){var o,a,n,i,s,p,u,h,c;if(e===r)return 0;if(h=e.length,c=r.length,h&&c){for(s=0,p=0,o=void 0,a=void 0,n=void 0,i=void 0,u=t;h>s;)u[s]=++s;for(;c>p;)for(i=r.charCodeAt(p),o=p,++p,a=p,s=0;h>s;)n=o+(e.charCodeAt(s)!==i?1:0),o=u[s],a=o>a?n>a?a+1:n:n>o?o+1:n,u[s]=a,++s;return a}return h+c}}(),sortQuery=function(t,e){var r,o;return r=t.query,o=e.query,o>r?-1:r>o?1:0},sortRank=function(t,e){var r,o;return r=Number(t.rank),o=Number(e.rank),o>r?-1:r>o?1:0},get_data=function(t,e){var r,o,a,n,i;for(i=[],a=0,n=t.length;n>a;a++)o=t[a],r=0,i.push(request(o,function(t,e,r){var o,a;t||200!==e.statusCode||(o=cheerio.load(r),a=[],o("div.bkp-listing").each(function(){var t,e,r,n,i,s;e=o(this).find("h2.bkp-toggle-vid").text().replace("(","").replace(")","").replace("'","").split(" â€“ "),t=e[0],s=e[1],n=t+" "+s,i=o(this).find("span.bkp-vid-rank").text(),r={artist:t,title:s,query:n.toLowerCase(),rank:i},a.push(r)}),o("div.list_song tr").each(function(){var t,e,r,n,i;t=o(this).find(".tit_artist a:first-child").text().replace("(","").replace(")","").replace("'",""),i=o(this).find(".tit_song a").text().replace("(","").replace(")","").replace("'",""),n=o(this).find(".nb em").text(),r=t+" "+i,e={artist:t,title:i,query:r.toLowerCase(),rank:n},a.push(e)}),songs.push(a))}).on("end",function(){var t,o,a;if(r++,r===pages.length){for(a=[],a=a.concat.apply(a,songs),t=0,o=a.length;o>t;)a[t]&&a.push(a[t]),t++;return a.splice(0,o),e(a)}}));return i},(update_data=function(){return get_data(pages,function(t){var e,r,o,a,n,i,s,p,u;for(t.sort(sortQuery),e=[],n="",r=0;r<t.length;)a=levenstein(t[r].query,n.query||""),a>6&&e.push(t[r]),n=t[r],r++;for(s=e,s.sort(sortRank),o=p=0,u=s.length;u>p;o=++p)i=s[o],i.rank=o+1,i.change=0,i.num_days=0;return fs.readFile(out_file,"utf8","w",function(t,e){var r,o,a,n,p,u,h,c,f,l,g,d,w,k,y,m;if(n=t?[]:JSON.parse(e),o={date:new Date,data:s},n.unshift(o),n.length>100&&n.pop,n.length>1)for(k=n[0].data,u=0,f=k.length;f>u;u++){if(i=k[u],r=0,n.length>=7)for(y=n[6].data,h=0,l=y.length;l>h;h++)p=y[h],p.query===i.query&&(i.change=p.rank-i.rank);for(c=0,g=n.length;g>c;c++)for(o=n[c],m=o.data,w=0,d=m.length;d>w;w++)a=m[w],a.query===i.query&&r++;i.num_days=r}return fs.writeFile(out_file,JSON.stringify(n),function(t){if(t)throw t;console.log("JSON saved to "+out_file)}),request.post({url:"http://localhost:3000/update",body:JSON.stringify(n),headers:{"Content-Type":"application/json;charset=UTF-8"}},function(t,e){console.log(e.statusCode)})})})})();
